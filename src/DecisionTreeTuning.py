from sklearn.model_selection import GridSearchCV
from sklearn.tree import DecisionTreeClassifier
from sklearn.pipeline import Pipeline

from preprocess import (
    load_and_prepare_data,
    split_data,
    build_tree_preprocessor,
)


def tune_decision_tree():

    X, y = load_and_prepare_data()
    X_train, X_test, y_train, y_test = split_data(X, y)

    preprocessor = build_tree_preprocessor(X_train)

    pipeline = Pipeline(
        steps=[
            ("preprocess", preprocessor),
            ("tree", DecisionTreeClassifier(random_state=2025)),
        ]
    )

    param_grid = {
        "tree__max_depth": [None, 5, 10, 15, 20],
        "tree__min_samples_split": [2, 10, 20, 50],
        "tree__min_samples_leaf": [1, 5, 10],
        "tree__class_weight": [None, "balanced"],
    }

    grid_search = GridSearchCV(
        estimator=pipeline,
        param_grid=param_grid,
        scoring="f1",
        cv=3,
        n_jobs=-1,
        verbose=1,
    )

    print("Running GridSearchCV for Decision Tree...")
    grid_search.fit(X_train, y_train)

    print("\nBest parameters found:", grid_search.best_params_)
    print("Best CV F1-score:", grid_search.best_score_)

    best_model = grid_search.best_estimator_
    best_params = grid_search.best_params_

    return best_model, best_params


if __name__ == "__main__":
    # manual run
    best_model, best_params = tune_decision_tree()
    print("\nBest parameters (for final model):", best_params)